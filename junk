param(
    [Parameter(Mandatory=$false)][String]$ISOPath
)
$ISOPath = "C:\temp\SW_DVD9_Win_Pro_11_23H2.6_64BIT_English_Pro_Ent_EDU_N_MLF_X23-75490.ISO"
$ExpandedDrivers = "$($PSScriptRoot)\ExpandedDrivers"
$DriverExes = "$($PSScriptRoot)\DriverExes"
$MountExtraction = "$($PSScriptRoot)\MountExtraction"
$OfflineImage = "$($PSScriptRoot)\OfflineImage"

$SPNumbers = [System.Collections.Generic.List[Object]]@()
$Models = Import-CSV $PSScriptRoot\HPModels.csv
$Models.Product | ForEach-Object {
    Get-SoftpaqList -Platform $_ -Category Driver -Os Win11 -OsVer 23H2 | `
    ? {$_.Category -eq 'Driver - Network' -or $_.Category -eq 'Driver - Keyboard, Mouse and Input Devices'} | ForEach-Object {
        $SPNumber = $_.id -replace '^sp',''
        $SPNumbers.Add($SPNumber)
    }
}
if (!(Test-Path $DriverExes)) {[Void](New-Item -ItemType Directory -Path $DriverExes)}
Push-Location $DriverExes
$SPNumbers | ForEach-Object {
    Get-Softpaq -Number $_ -DestinationPath $DriverExes -FriendlyName
}
Pop-Location
$Exes = Get-Item $DriverExes\*.exe
$Exes | ForEach {
    $Name = $_.Name -replace '\.exe$',''
    Start-Process "C:\Program Files\7-Zip\7z.exe" -ArgumentList "x $($_.FullName) -o`"$($ExpandedDrivers)\$($Name)`" -y" -Wait -NoNewWindow
}

Start-Process "C:\Program Files\7-zip\7z.exe" -ArgumentList "x $($ISOPath) -o`"$($MountExtraction)`" -y" -Wait -NoNewWindow
if (!(Test-Path $OfflineImage)) {[Void](New-Item -ItemType Directory -Path $OfflineImage)}
Mount-WindowsImage -ImagePath "$($MountExtraction)\sources\install.wim" -Index 3 -Path $OfflineImage
if (!(Test-Path $ExpandedDrivers)) {[Void](New-Item -ItemType Directory -Path $ExpandedDrivers)}
try {
    #Add-WindowsDriver -Path $PSScriptRoot\OfflineImage -Driver $PSScriptRoot\ExpandedDrivers -Recurse -ErrorAction Stop
    Dism /Image:"$OfflineImage" /Add-Driver /Driver:"$ExpandedDrivers" /Recurse
    Write-Host -ForegroundColor Green "Dismounting and committing..."
    Dismount-WindowsImage -Path $OfflineImage -Save -ErrorAction Stop
}
catch {
    $_
    Write-Host -ForegroundColor Green "Dismounting and discarding..."
    Dismount-WindowsImage -Path $OfflineImage -Discard
}

Start-Process "C:\Program Files (x86)\Windows Kits\10\Assessment and Deployment Kit\Deployment Tools\amd64\oscdimg\oscdimg.exe" -ArgumentList `
"-m -o -u2 -udfver102 -bootdata:2#p0,e,betfsboot.com#pEF,e,befisys.bin $($MountExtraction) $($PSScriptRoot)\Win11x64.iso" -Wait -NoNewWindow -WorkingDirectory "C:\Program Files (x86)\Windows Kits\10\Assessment and Deployment Kit\Deployment Tools\amd64\oscdimg"
